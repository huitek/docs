---
title: 37 消息传输协议
subtitle: 简化版本的 MQTT
tags: 
    - IoT
    - MQTT
    - 自主物联网消息传输协议
    - 37
    - mtp
---

# 1. 文档更新记录

## 1.1 版本记录

| 作者 | 发布日期 | 版本 | 备注 |
| :-- | :-- | :-- | :-- |
| Le | 2018-10-09 | 1.0 | 文档定稿 |
| Le | 2017-07-02 | beta | 文档起草 |

## 1.2 问题反馈

如有任何疑问或者问题反馈，请发邮件至 thisiswangle@gmail.com 或者发起 issue

# 2. 概要

37 消息通信协议（下面简称 37）是一个物联网点对点消息通信协议，可以替代 MQTT 来使用。37 无 MQTT、AMQP 等消息协议中的 Topic, 是一个更直观的点对点通信协议。MQTT需要 SSL 的加持，在一定程度上提高了设备的接入要求，37 支持在不需要 SSL 的情况下，可以通过 AES 对称加密算法来实现数据的可靠传输。

协议为什么叫 37？因为我们定义协议的头的第一个字节（魔数）永远为 37。

# 3. 术语

## 3.1 设备

指数据采集设备：设备可以直接和云端服务器连接，发送采集到的数据到云端服务器, 云端服务器亦可下发指令给设备，以控制设备。

## 3.2 网关

指设备由于一些原因不能够直接与云端服务器连接，则设备先发送数据到网关，网关在合适的时机再发送数据到云端服务器，反之亦然。

# 4. 协议定义

## 4.1 数据流

设备或网关(下简称客户端)与云平台服务器(下简称服务器)通信采用 TCP 方式，其它约束：

* 同一个客户端在任意时刻只能与服务器建立一个 TCP 连接;
* 服务器在任意时刻只允许同一合法客户端建立一个 TCP 连接，若客户端重复建立 TCP 连接，服务器将会保留最新的连接，并关闭之前的所有连接;
* 客户端 30s 内最多尝试重复建立 TCP 链接 5 次，超过限制该客户端将会被封禁 10min
* 客户端需要自行保持 TCP 连接的存活(定时发送 KeepAlive 消息)，若 60s 内客户端没有发送任何数据抵达服务端，服务器将会主动关闭 TCP 连接以节省资源。

## 4.2 数据包

在数据流之上运载着业务逻辑的数据包，数据包的发送方和接受方：

* 客户端 <-> 服务器
* 服务器 <-> 客户端

## 4.3 数据包结构

数据包有定长数据头和变长载荷组成, 结构如图:

<p align="center">
    <img width="80%" src="/assets/zh-CN/protocol/37-packet.png"/>
</p>

## 4.4 魔数

设置为 0x37，更多可见第一节概要中的说明.

## 4.5 命令类型

固定头的第 2 个字节的高 4 位表示命令，低 4 位为命令的参数，如图：

<p align="center">
    <img width="80%" src="/assets/zh-CN/protocol/37-cmd.png"/>
</p>

## 4.6 字节序

**大端**.  涉及到多字节的数值需要考虑这个问题

# 5. 协议命令

## 5.1 命令列表

固定头的第 2 个字节的高 4 位表示命令，低 4 位为命令的参数

| 命令 | 命令值(十进制)  | 命令发送方向 | 功能 |
| :--    | :--   | :--  | :--          |
| Reserved     |  0  | 禁止 | 保留 |
| HANDSHAKE    |  1  | 服务器 <- 客户端 | 握手，客户端发送ID进行验证 |
| HANDSHAKEACK |  2  | 服务器 -> 客户端 | 握手回复，服务器端发送验证信息 |
| CONNECT      |  3  | 服务器 <- 客户端 | 客户端请求连接服务器 |
| CONNACK      |  4  | 服务器 -> 客户端 | 连接回复 |
| PUB          |  5  | 服务器 <-> 客户端 | 发布消息 QoS 0/1/2 |
| PUBACK       |  6  | 服务器 <-> 客户端 | QoS 1 消息发布收到确认 |
| PUBREC       |  7  | 服务器 <-> 客户端 | 发布收到(保证交付第一步)，QoS 2 的 PUB消息回应 |
| PUBREL       |  8  | 服务器 <-> 客户端 | 发布释放(保证交付第二步)，PUBREC 的回应 |
| PUBCOMP      |  9  | 服务器 <-> 客户端 | QoS 2 消息发布完成(保证交付第三步)，PUBREL 的回应 |
| PINGREQ      |  10 | 服务器 <- 客户端 | 心跳请求 |
| PINGRESP     |  11 | 服务器 -> 客户端 | 心跳响应 |
| DISCONNECT   |  12 | 服务器 <- 客户端 | 退出登录 |
| Reserved     |  13 | 禁止 | 保留 |
| Reserved     |  14 | 禁止 | 保留 |
| Reserved     |  15 | 禁止 | 保留 |

## 5.2 命令参数

除 PUB 外，其它命令参数均为 0.

PUB 参数说明

| 参数 | 参数值(十进制)   | 说明 |
| :--    | :--   | :--  |
| QoS 0     |  0  | 发送 QoS 0 级别消息，最多一次 |
| QoS 1     |  1  | 发送 QoS 1 级别消息，最少一次 |
| QoS 2     |  2  | 发送 QoS 2 级别消息，有且仅有一次 |

## 5.3 命令载荷

### 5.3.1 HANDSHAKE

| 包内顺序|  字节长度  | 值类型 | 说明 |
| :--    | :--   | :--          | :-- |
| 0 | 2 |  ushort | 客户端ID数据长度 |
| 1 | - |  bytes | 客户端ID |

### 5.3.2 HANDSHAKEACK

| 包内顺序|  字节长度  | 值类型 | 说明 |
| :--     | :--   | :--          | :-- |
| 0       | 2    |  ushort | 随机密钥长度 |
| 1       | -    |  bytes | 随机密钥 |

### 5.3.3 CONNECT

| 包内顺序|  字节长度  | 值类型 | 说明 |
| :--     | :--   | :--          | :-- |
| 0 | 2 | ushort | 客户端 ID 长度 |
| 1       | -     |  bytes | 客户端 ID |
| 2 | 1 | ubyte | 签名算法名称长度 |
| 3       | -     |  bytes | 签名算法名称，可选值为：MD5 |
| 4 | 2 | ushort | 签名字符串长度 |
| 5       | -     |  bytes | 签名 |

### 5.3.4 CONNACK

空

### 5.3.5 PUB

透传所有数据

### 5.3.6 PUBACK

| 包内顺序|  字节长度  | 值类型 | 说明 |
| :--     | :--   | :--          | :-- |
| 0 | 2 | ushort | 消息序号 |

### 5.3.7 PUBREC

| 包内顺序|  字节长度  | 值类型 | 说明 |
| :--     | :--   | :--          | :-- |
| 0 | 2 | ushort | 消息序号 |

### 5.3.8 PUBREL

| 包内顺序|  字节长度  | 值类型 | 说明 |
| :--     | :--   | :--          | :-- |
| 0 | 2 | ushort | 消息序号 |

### 5.3.9 PUBCOMP

| 包内顺序|  字节长度  | 值类型 | 说明 |
| :--     | :--   | :--          | :-- |
| 0 | 2 | ushort | 消息序号 |

### 5.3.10 PINGREQ

空

### 5.3.11 PINGRESP

空

### 5.3.12 DISCONNECT

空
