<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>37 消息传输协议 | 慧通云文档中心</title>
    <meta name="description" content="">
    <meta name="keywords" content="huitong iot hiot">
  <link rel="shortcut icon" href="/docs/images/logo.png">
    
    <link rel="preload" href="/docs/assets/css/0.styles.377baa5a.css" as="style"><link rel="preload" href="/docs/assets/js/app.0995f894.js" as="script"><link rel="preload" href="/docs/assets/js/2.42816055.js" as="script"><link rel="preload" href="/docs/assets/js/16.5ce1cc00.js" as="script"><link rel="prefetch" href="/docs/assets/js/10.84f69f66.js"><link rel="prefetch" href="/docs/assets/js/11.948a97c9.js"><link rel="prefetch" href="/docs/assets/js/12.cb573d50.js"><link rel="prefetch" href="/docs/assets/js/13.3ffd6394.js"><link rel="prefetch" href="/docs/assets/js/14.47b6ce0c.js"><link rel="prefetch" href="/docs/assets/js/15.bd230a5c.js"><link rel="prefetch" href="/docs/assets/js/17.4c1bac56.js"><link rel="prefetch" href="/docs/assets/js/3.755ef75a.js"><link rel="prefetch" href="/docs/assets/js/4.7a86ff28.js"><link rel="prefetch" href="/docs/assets/js/5.f0d5f544.js"><link rel="prefetch" href="/docs/assets/js/6.eb913e41.js"><link rel="prefetch" href="/docs/assets/js/7.d351ee73.js"><link rel="prefetch" href="/docs/assets/js/8.030926ab.js"><link rel="prefetch" href="/docs/assets/js/9.8e8e47f6.js">
    <link rel="stylesheet" href="/docs/assets/css/0.styles.377baa5a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/docs/" class="home-link router-link-active"><img src="/docs/images/logo.png" alt="慧通云文档中心" class="logo"> <span class="site-name can-hide">慧通云文档中心</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/docs/docs/quick-start/" class="nav-link">快速入门</a></div> <a href="https://github.com/huitong-technologies/docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/docs/docs/quick-start/" class="nav-link">快速入门</a></div> <a href="https://github.com/huitong-technologies/docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>简介</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/docs/product-intro/" class="sidebar-link">慧通云</a></li><li><a href="/docs/docs/product-intro/function-intro.html" class="sidebar-link">功能介绍</a></li><li><a href="/docs/docs/product-intro/terms.html" class="sidebar-link">名词解释</a></li><li><a href="/docs/docs/product-intro/limit.html" class="sidebar-link">使用限制</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>快速入门</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/docs/quick-start/" class="sidebar-link">快速入门</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_1-文档更新记录"><a href="#_1-文档更新记录" aria-hidden="true" class="header-anchor">#</a> 1. 文档更新记录</h1> <h2 id="_1-1-版本记录"><a href="#_1-1-版本记录" aria-hidden="true" class="header-anchor">#</a> 1.1 版本记录</h2> <table><thead><tr><th style="text-align:left;">作者</th> <th style="text-align:left;">发布日期</th> <th style="text-align:left;">版本</th> <th style="text-align:left;">备注</th></tr></thead> <tbody><tr><td style="text-align:left;">Le</td> <td style="text-align:left;">2018-10-09</td> <td style="text-align:left;">1.0</td> <td style="text-align:left;">文档定稿</td></tr> <tr><td style="text-align:left;">Le</td> <td style="text-align:left;">2017-07-02</td> <td style="text-align:left;">beta</td> <td style="text-align:left;">文档起草</td></tr></tbody></table> <h2 id="_1-2-问题反馈"><a href="#_1-2-问题反馈" aria-hidden="true" class="header-anchor">#</a> 1.2 问题反馈</h2> <p>如有任何疑问或者问题反馈，请发邮件至 thisiswangle@gmail.com 或者发起 issue</p> <h1 id="_2-概要"><a href="#_2-概要" aria-hidden="true" class="header-anchor">#</a> 2. 概要</h1> <p>37 消息通信协议（下面简称 37）是一个物联网点对点消息通信协议，可以替代 MQTT 来使用。37 无 MQTT、AMQP 等消息协议中的 Topic, 是一个更直观的点对点通信协议。MQTT需要 SSL 的加持，在一定程度上提高了设备的接入要求，37 支持在不需要 SSL 的情况下，可以通过 AES 对称加密算法来实现数据的可靠传输。</p> <p>协议为什么叫 37？因为我们定义协议的头的第一个字节（魔数）永远为 37。</p> <h1 id="_3-术语"><a href="#_3-术语" aria-hidden="true" class="header-anchor">#</a> 3. 术语</h1> <h2 id="_3-1-设备"><a href="#_3-1-设备" aria-hidden="true" class="header-anchor">#</a> 3.1 设备</h2> <p>指数据采集设备：设备可以直接和云端服务器连接，发送采集到的数据到云端服务器, 云端服务器亦可下发指令给设备，以控制设备。</p> <h2 id="_3-2-网关"><a href="#_3-2-网关" aria-hidden="true" class="header-anchor">#</a> 3.2 网关</h2> <p>指设备由于一些原因不能够直接与云端服务器连接，则设备先发送数据到网关，网关在合适的时机再发送数据到云端服务器，反之亦然。</p> <h1 id="_4-协议定义"><a href="#_4-协议定义" aria-hidden="true" class="header-anchor">#</a> 4. 协议定义</h1> <h2 id="_4-1-数据流"><a href="#_4-1-数据流" aria-hidden="true" class="header-anchor">#</a> 4.1 数据流</h2> <p>设备或网关(下简称客户端)与云平台服务器(下简称服务器)通信采用 TCP 方式，其它约束：</p> <ul><li>同一个客户端在任意时刻只能与服务器建立一个 TCP 连接;</li> <li>服务器在任意时刻只允许同一合法客户端建立一个 TCP 连接，若客户端重复建立 TCP 连接，服务器将会保留最新的连接，并关闭之前的所有连接;</li> <li>客户端 30s 内最多尝试重复建立 TCP 链接 5 次，超过限制该客户端将会被封禁 10min</li> <li>客户端需要自行保持 TCP 连接的存活(定时发送 KeepAlive 消息)，若 60s 内客户端没有发送任何数据抵达服务端，服务器将会主动关闭 TCP 连接以节省资源。</li></ul> <h2 id="_4-2-数据包"><a href="#_4-2-数据包" aria-hidden="true" class="header-anchor">#</a> 4.2 数据包</h2> <p>在数据流之上运载着业务逻辑的数据包，数据包的发送方和接受方：</p> <ul><li>客户端 &lt;-&gt; 服务器</li> <li>服务器 &lt;-&gt; 客户端</li></ul> <h2 id="_4-3-数据包结构"><a href="#_4-3-数据包结构" aria-hidden="true" class="header-anchor">#</a> 4.3 数据包结构</h2> <p>数据包有定长数据头和变长载荷组成, 结构如图:</p> <p align="center"><img width="80%" src="/assets/zh-CN/protocol/37-packet.png"></p> <h2 id="_4-4-魔数"><a href="#_4-4-魔数" aria-hidden="true" class="header-anchor">#</a> 4.4 魔数</h2> <p>设置为 0x37，更多可见第一节概要中的说明.</p> <h2 id="_4-5-命令类型"><a href="#_4-5-命令类型" aria-hidden="true" class="header-anchor">#</a> 4.5 命令类型</h2> <p>固定头的第 2 个字节的高 4 位表示命令，低 4 位为命令的参数，如图：</p> <p align="center"><img width="80%" src="/assets/zh-CN/protocol/37-cmd.png"></p> <h2 id="_4-6-字节序"><a href="#_4-6-字节序" aria-hidden="true" class="header-anchor">#</a> 4.6 字节序</h2> <p><strong>大端</strong>.  涉及到多字节的数值需要考虑这个问题</p> <h1 id="_5-协议命令"><a href="#_5-协议命令" aria-hidden="true" class="header-anchor">#</a> 5. 协议命令</h1> <h2 id="_5-1-命令列表"><a href="#_5-1-命令列表" aria-hidden="true" class="header-anchor">#</a> 5.1 命令列表</h2> <p>固定头的第 2 个字节的高 4 位表示命令，低 4 位为命令的参数</p> <table><thead><tr><th style="text-align:left;">命令</th> <th style="text-align:left;">命令值(十进制)</th> <th style="text-align:left;">命令发送方向</th> <th style="text-align:left;">功能</th></tr></thead> <tbody><tr><td style="text-align:left;">Reserved</td> <td style="text-align:left;">0</td> <td style="text-align:left;">禁止</td> <td style="text-align:left;">保留</td></tr> <tr><td style="text-align:left;">HANDSHAKE</td> <td style="text-align:left;">1</td> <td style="text-align:left;">服务器 &lt;- 客户端</td> <td style="text-align:left;">握手，客户端发送ID进行验证</td></tr> <tr><td style="text-align:left;">HANDSHAKEACK</td> <td style="text-align:left;">2</td> <td style="text-align:left;">服务器 -&gt; 客户端</td> <td style="text-align:left;">握手回复，服务器端发送验证信息</td></tr> <tr><td style="text-align:left;">CONNECT</td> <td style="text-align:left;">3</td> <td style="text-align:left;">服务器 &lt;- 客户端</td> <td style="text-align:left;">客户端请求连接服务器</td></tr> <tr><td style="text-align:left;">CONNACK</td> <td style="text-align:left;">4</td> <td style="text-align:left;">服务器 -&gt; 客户端</td> <td style="text-align:left;">连接回复</td></tr> <tr><td style="text-align:left;">PUB</td> <td style="text-align:left;">5</td> <td style="text-align:left;">服务器 &lt;-&gt; 客户端</td> <td style="text-align:left;">发布消息 QoS 0/1/2</td></tr> <tr><td style="text-align:left;">PUBACK</td> <td style="text-align:left;">6</td> <td style="text-align:left;">服务器 &lt;-&gt; 客户端</td> <td style="text-align:left;">QoS 1 消息发布收到确认</td></tr> <tr><td style="text-align:left;">PUBREC</td> <td style="text-align:left;">7</td> <td style="text-align:left;">服务器 &lt;-&gt; 客户端</td> <td style="text-align:left;">发布收到(保证交付第一步)，QoS 2 的 PUB消息回应</td></tr> <tr><td style="text-align:left;">PUBREL</td> <td style="text-align:left;">8</td> <td style="text-align:left;">服务器 &lt;-&gt; 客户端</td> <td style="text-align:left;">发布释放(保证交付第二步)，PUBREC 的回应</td></tr> <tr><td style="text-align:left;">PUBCOMP</td> <td style="text-align:left;">9</td> <td style="text-align:left;">服务器 &lt;-&gt; 客户端</td> <td style="text-align:left;">QoS 2 消息发布完成(保证交付第三步)，PUBREL 的回应</td></tr> <tr><td style="text-align:left;">PINGREQ</td> <td style="text-align:left;">10</td> <td style="text-align:left;">服务器 &lt;- 客户端</td> <td style="text-align:left;">心跳请求</td></tr> <tr><td style="text-align:left;">PINGRESP</td> <td style="text-align:left;">11</td> <td style="text-align:left;">服务器 -&gt; 客户端</td> <td style="text-align:left;">心跳响应</td></tr> <tr><td style="text-align:left;">DISCONNECT</td> <td style="text-align:left;">12</td> <td style="text-align:left;">服务器 &lt;- 客户端</td> <td style="text-align:left;">退出登录</td></tr> <tr><td style="text-align:left;">Reserved</td> <td style="text-align:left;">13</td> <td style="text-align:left;">禁止</td> <td style="text-align:left;">保留</td></tr> <tr><td style="text-align:left;">Reserved</td> <td style="text-align:left;">14</td> <td style="text-align:left;">禁止</td> <td style="text-align:left;">保留</td></tr> <tr><td style="text-align:left;">Reserved</td> <td style="text-align:left;">15</td> <td style="text-align:left;">禁止</td> <td style="text-align:left;">保留</td></tr></tbody></table> <h2 id="_5-2-命令参数"><a href="#_5-2-命令参数" aria-hidden="true" class="header-anchor">#</a> 5.2 命令参数</h2> <p>除 PUB 外，其它命令参数均为 0.</p> <p>PUB 参数说明</p> <table><thead><tr><th style="text-align:left;">参数</th> <th style="text-align:left;">参数值(十进制)</th> <th style="text-align:left;">说明</th></tr></thead> <tbody><tr><td style="text-align:left;">QoS 0</td> <td style="text-align:left;">0</td> <td style="text-align:left;">发送 QoS 0 级别消息，最多一次</td></tr> <tr><td style="text-align:left;">QoS 1</td> <td style="text-align:left;">1</td> <td style="text-align:left;">发送 QoS 1 级别消息，最少一次</td></tr> <tr><td style="text-align:left;">QoS 2</td> <td style="text-align:left;">2</td> <td style="text-align:left;">发送 QoS 2 级别消息，有且仅有一次</td></tr></tbody></table> <h2 id="_5-3-命令载荷"><a href="#_5-3-命令载荷" aria-hidden="true" class="header-anchor">#</a> 5.3 命令载荷</h2> <h3 id="_5-3-1-handshake"><a href="#_5-3-1-handshake" aria-hidden="true" class="header-anchor">#</a> 5.3.1 HANDSHAKE</h3> <table><thead><tr><th style="text-align:left;">包内顺序</th> <th style="text-align:left;">字节长度</th> <th style="text-align:left;">值类型</th> <th style="text-align:left;">说明</th></tr></thead> <tbody><tr><td style="text-align:left;">0</td> <td style="text-align:left;">2</td> <td style="text-align:left;">ushort</td> <td style="text-align:left;">客户端ID数据长度</td></tr> <tr><td style="text-align:left;">1</td> <td style="text-align:left;">-</td> <td style="text-align:left;">bytes</td> <td style="text-align:left;">客户端ID</td></tr></tbody></table> <h3 id="_5-3-2-handshakeack"><a href="#_5-3-2-handshakeack" aria-hidden="true" class="header-anchor">#</a> 5.3.2 HANDSHAKEACK</h3> <table><thead><tr><th style="text-align:left;">包内顺序</th> <th style="text-align:left;">字节长度</th> <th style="text-align:left;">值类型</th> <th style="text-align:left;">说明</th></tr></thead> <tbody><tr><td style="text-align:left;">0</td> <td style="text-align:left;">2</td> <td style="text-align:left;">ushort</td> <td style="text-align:left;">随机密钥长度</td></tr> <tr><td style="text-align:left;">1</td> <td style="text-align:left;">-</td> <td style="text-align:left;">bytes</td> <td style="text-align:left;">随机密钥</td></tr></tbody></table> <h3 id="_5-3-3-connect"><a href="#_5-3-3-connect" aria-hidden="true" class="header-anchor">#</a> 5.3.3 CONNECT</h3> <table><thead><tr><th style="text-align:left;">包内顺序</th> <th style="text-align:left;">字节长度</th> <th style="text-align:left;">值类型</th> <th style="text-align:left;">说明</th></tr></thead> <tbody><tr><td style="text-align:left;">0</td> <td style="text-align:left;">2</td> <td style="text-align:left;">ushort</td> <td style="text-align:left;">客户端 ID 长度</td></tr> <tr><td style="text-align:left;">1</td> <td style="text-align:left;">-</td> <td style="text-align:left;">bytes</td> <td style="text-align:left;">客户端 ID</td></tr> <tr><td style="text-align:left;">2</td> <td style="text-align:left;">1</td> <td style="text-align:left;">ubyte</td> <td style="text-align:left;">签名算法名称长度</td></tr> <tr><td style="text-align:left;">3</td> <td style="text-align:left;">-</td> <td style="text-align:left;">bytes</td> <td style="text-align:left;">签名算法名称，可选值为：MD5</td></tr> <tr><td style="text-align:left;">4</td> <td style="text-align:left;">2</td> <td style="text-align:left;">ushort</td> <td style="text-align:left;">签名字符串长度</td></tr> <tr><td style="text-align:left;">5</td> <td style="text-align:left;">-</td> <td style="text-align:left;">bytes</td> <td style="text-align:left;">签名</td></tr></tbody></table> <h3 id="_5-3-4-connack"><a href="#_5-3-4-connack" aria-hidden="true" class="header-anchor">#</a> 5.3.4 CONNACK</h3> <p>空</p> <h3 id="_5-3-5-pub"><a href="#_5-3-5-pub" aria-hidden="true" class="header-anchor">#</a> 5.3.5 PUB</h3> <p>透传所有数据</p> <h3 id="_5-3-6-puback"><a href="#_5-3-6-puback" aria-hidden="true" class="header-anchor">#</a> 5.3.6 PUBACK</h3> <table><thead><tr><th style="text-align:left;">包内顺序</th> <th style="text-align:left;">字节长度</th> <th style="text-align:left;">值类型</th> <th style="text-align:left;">说明</th></tr></thead> <tbody><tr><td style="text-align:left;">0</td> <td style="text-align:left;">2</td> <td style="text-align:left;">ushort</td> <td style="text-align:left;">消息序号</td></tr></tbody></table> <h3 id="_5-3-7-pubrec"><a href="#_5-3-7-pubrec" aria-hidden="true" class="header-anchor">#</a> 5.3.7 PUBREC</h3> <table><thead><tr><th style="text-align:left;">包内顺序</th> <th style="text-align:left;">字节长度</th> <th style="text-align:left;">值类型</th> <th style="text-align:left;">说明</th></tr></thead> <tbody><tr><td style="text-align:left;">0</td> <td style="text-align:left;">2</td> <td style="text-align:left;">ushort</td> <td style="text-align:left;">消息序号</td></tr></tbody></table> <h3 id="_5-3-8-pubrel"><a href="#_5-3-8-pubrel" aria-hidden="true" class="header-anchor">#</a> 5.3.8 PUBREL</h3> <table><thead><tr><th style="text-align:left;">包内顺序</th> <th style="text-align:left;">字节长度</th> <th style="text-align:left;">值类型</th> <th style="text-align:left;">说明</th></tr></thead> <tbody><tr><td style="text-align:left;">0</td> <td style="text-align:left;">2</td> <td style="text-align:left;">ushort</td> <td style="text-align:left;">消息序号</td></tr></tbody></table> <h3 id="_5-3-9-pubcomp"><a href="#_5-3-9-pubcomp" aria-hidden="true" class="header-anchor">#</a> 5.3.9 PUBCOMP</h3> <table><thead><tr><th style="text-align:left;">包内顺序</th> <th style="text-align:left;">字节长度</th> <th style="text-align:left;">值类型</th> <th style="text-align:left;">说明</th></tr></thead> <tbody><tr><td style="text-align:left;">0</td> <td style="text-align:left;">2</td> <td style="text-align:left;">ushort</td> <td style="text-align:left;">消息序号</td></tr></tbody></table> <h3 id="_5-3-10-pingreq"><a href="#_5-3-10-pingreq" aria-hidden="true" class="header-anchor">#</a> 5.3.10 PINGREQ</h3> <p>空</p> <h3 id="_5-3-11-pingresp"><a href="#_5-3-11-pingresp" aria-hidden="true" class="header-anchor">#</a> 5.3.11 PINGRESP</h3> <p>空</p> <h3 id="_5-3-12-disconnect"><a href="#_5-3-12-disconnect" aria-hidden="true" class="header-anchor">#</a> 5.3.12 DISCONNECT</h3> <p>空</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/docs/assets/js/app.0995f894.js" defer></script><script src="/docs/assets/js/2.42816055.js" defer></script><script src="/docs/assets/js/16.5ce1cc00.js" defer></script>
  </body>
</html>
